{% comment %}
  Hemlock & Oak — Rewards & Referrals (Starbucks-style, two sections)
  - Section 1 Points & Rewards (points balance + points progress + redeem + earn table)
  - Section 2 Refer a Friend (referral link + share + referral progress with milestones)
  IDs used by JS are preserved. New IDs
    - #points-progress-bar  (fill)
    - #points-progress-marker (little star marker)
{% endcomment %}

style
 ===================== Hemlock & Oak — Rewards & Referrals ===================== 
root{
  --primary#1f6d7d;
  --secondary#ac8e69;
  --gradient1#ac8e69; 
  --gradient2#d1b088; 
  --dark#354744;
  --light#f4f4f2;
  --bordertransparent;
  --success#4CAF50;
  --error#DC3545;
  --rail#ecebe8;
  --cardrgba(250, 250, 248, 0.999);
  --shadow0 2px 8px rgba(0,0,0,.03);
  --radius5px;
  --gap20px;
  --section-gap30px;
}

.account-referrals{
  width100%;
  colorvar(--dark);
}

.ref-h6 { 
  font-weight 700; 
  font-size x-large;
  margin-block-end -15px !important;
}

 ---------- Header ---------- 
.account-header{ margin-bottom24px; }
.header-content{
  displayflex; align-itemscenter; padding-bottom12px; border-bottom2px solid var(--secondary);
}
.account-header-font{ font-size32px !important; font-weight600; margin0; letter-spacing 0.15px }

 Brand lockup requested 
.rewards-title{ displayinline-flex; align-itemscenter; gap12px; }
.rewards-title img{ width115px; heightauto; displayblock; }

 ---------- Notifications ---------- 
.notification-banner{
  displaynone; align-itemscenter; margin16px 0; padding12px 15px;
  background#e6f7ed; border1px solid var(--success);box-shadowvar(--shadow);
}
.notification-banner.error{ background#ffe5e5; border-color#ffbdbd; }
.notification-content{ displayflex; justify-contentspace-between; width100%; }
#notification-message{ display none;colorvar(--success); font-weight600; }
.notification-banner.error #notification-message{ color#e74c3c; }
.notification-close{ backgroundnone; bordernone; font-size18px; cursorpointer; opacity.7; }
.notification-closehover{ opacity1; }

 ---------- Section shells ---------- 
.rewards-shell,.referrals-shell{
  backgroundvar(--card); border1px solid var(--border); border-radiusvar(--radius);
  box-shadowvar(--shadow); padding24px;
}

 ---------- Points header + number ---------- 
.points-balance{
  displayflex; align-itemsflex-start; gap28px; flex-wrapwrap;
}
.points-sub{ font-size12px; letter-spacing.12em; text-transformuppercase; color#777; }
.points-balance .big{ font-size56px; font-weight200; colorvar(--primary); line-height1; letter-spacing-1px; }

 ---------- Starbucks-like POINTS rail ---------- 
.points-rail{ flex1; min-width260px; margin-top16px;margin-right10px;margin-bottom30px;}

 Rail 
.rail{
  positionrelative; width100%; height8px; backgroundvar(--rail);
  border-radius999px; overflowvisible;  so the pin never gets clipped 
}
.rail-fill{
  height100%; width0%;
  backgroundlinear-gradient(90deg, var(--gradient1), var(--gradient2));
  border-radius999px; transitionwidth .45s ease;
}
 Marker pin 
.rail-marker{ positionabsolute; top-32px; transformtranslateX(-60%); }
.rail-marker .pin{ width22px; height22px; displayblock; filterdrop-shadow(0 1px 3px rgba(0,0,0,.15)); }

 NEW — ticks on the bar 
.rail-tick{
  positionabsolute; top0; transformtranslateX(-50%);
  width0; height100%; pointer-eventsnone;
  background-color #ac8e69;
}
.rail-tick .tick-dot{
  positionabsolute; top50%; left0; transformtranslate(-50%,-50%);
  width18px; height18px; border-radius50%;
  background#fff; border3px solid #d8d8d8; box-shadow0 0 0 1px rgba(0,0,0,.05) inset;
}
.rail-tick.unlocked .tick-dot{ border-colorvar(--secondary); background#c4a178; }
.rail-tick .tick-label{
  positionabsolute; topcalc(100% + 8px); left0; transformtranslateX(-50%);
  font-weight700; color#33423f; font-size14px; white-spacenowrap;
}
 Ticks under the rail 
.points-tier{ displayflex; align-itemscenter; gap10px; flex1; min-width70px; }
.points-tier .tier-dot{ width12px; height12px; border-radius50%; background#d6d6d6; }
.points-tier .tier-dot.unlocked{ backgroundvar(--secondary); }
.points-tier .tier-label{ font-weight600; font-size14px; color#33423f; }

 ---------- Redeem options ---------- 
.redeem-title{ font-size22px; font-weight600; text-aligncenter; margin18px 0 8px; }
.redeem-points-status{ text-aligncenter; margin-bottom12px; }
.redeem-options{ displayinline-flex; gap16px; margin-top16px; }
.redeem-option{
  backgroundvar(--card); border1px solid var(--border); border-radiusvar(--radius); padding16px; text-aligncenter;
  transitiontransform .15s ease, box-shadow .15s ease;
}
.redeem-optionhover{ transformtranslateY(-2px); box-shadowvar(--shadow); }
.redeem-option h4{ margin0 0 6px; font-size18px; }
.redeem-option p{ margin0 0 12px; color#666; font-size14px; }
.redeem-discount{
  width100%; padding12px 16px; bordernone; border-radiusvar(--radius); cursorpointer; font-weight600;
  backgroundvar(--primary); color#fff;
}
.redeem-discounthover{ background#5e1129; }
#last-discount-code{ margin-top12px; text-aligncenter; colorvar(--secondary); font-weight500; }
#redeem-message{ margin-top10px; text-aligncenter; font-weight600; }

 ---------- Refer-a-friend ---------- 
.refer-intro{ margin-bottom10px; text-aligncenter; }
.referral-link-box{ displayflex; gap10px; flex-wrapwrap; margin14px 0 18px; }
.referral-url-display{
  flex1; min-width220px; padding12px 14px; backgroundvar(--light); border1px solid var(--border); border-radius8px;
  font-size14px; overflowhidden; text-overflowellipsis; white-spacenowrap;
}
.copy-referral-btn{ padding12px 18px; bordernone; border-radius8px; backgroundvar(--secondary); color#fff; font-weight700; cursorpointer; }
.share-buttons{ displayflex; flex-wrapwrap; gap10px; }
.share-btn{
  displayflex; align-itemscenter; gap8px; padding8px 14px; background#fff; border1px solid var(--border);
  border-radius20px; cursorpointer; transitionbackground .15s ease;
}
.share-btnhover{ background#f4f4f2; }

 ---------- Referral progress (existing IDs) ---------- 
.ref-progress{ margin-top14px; }
.progress-bar-container{ width100%; height10px; backgroundvar(--rail); border-radius999px; overflowhidden; positionrelative; }
#progress-bar.progress-bar-fill{
  height100%; width0%; backgroundlinear-gradient(90deg, var(--gradient1), var(--gradient2));
  border-radius999px; transitionwidth .45s ease;
}
.milestone-indicators{ positionrelative; height70px; margin-top14px; }
.milestone{ positionabsolute; transformtranslateX(-50%); text-aligncenter; }
.milestone-dot{
  width12px; height12px; border-radius50%; backgroundvar(--secondary); margin0 auto 5px;
  border2px solid #fff; box-shadow0 0 0 1px var(--border);
}
.milestone-value{ font-weight600; }
.milestone-reward{ font-size14px; cursorpointer; }

 Misc 
.loading-indicator{
  displayinline-block; width18px; height18px; border2px solid rgba(255,255,255,.3);
  border-radius50%; border-top-color#fff; animationspin .8s linear infinite; margin-right8px;
}
@keyframes spin{ to{ transformrotate(360deg);} }

@media (max-width768px){
  .points-balance .big{ font-size44px; }
}
 Redeem carousel containment 
.redeem-wrap .scrollable-with-controls {
  position relative;
  max-width 100%;
  overflow hidden;  Prevent overflow 
}

.redeem-wrap .scroll-area {
  overflow-x auto;
  overflow-y hidden;
  scroll-snap-type x mandatory;
  -webkit-overflow-scrolling touch;
  scrollbar-width none;
  -ms-overflow-style none;
}

.redeem-wrap .scroll-area-webkit-scrollbar {
  display none;
}

.redeem-wrap .redeem-options {
  display flex;
  gap 16px;
  padding 4px 20px;
}

.redeem-wrap .redeem-option {
  flex 0 0 250px;
  scroll-snap-align start;
}
 On larger screens, make cards wider so only 3 fit 
@media (min-width 1000px) {
  .redeem-wrap .redeem-option {
    flex 0 0 calc(33.333% - 11px);  Show exactly 3 items 
  }
}

.redeem-wrap scroll-carousel {
  position relative;
}
 Position buttons absolutely within the container 
.redeem-wrap scroll-carousel .circle-button {
  position absolute;
  top 50%;
  transform translateY(-50%);
  z-index 10;
  background white;  Ensure buttons are visible 
}


.redeem-wrap scroll-carousel .circle-button[is=prev-button] {
  left 0;
}

.redeem-wrap scroll-carousel .circle-button[is=next-button] {
  right 0;
}

 ---------- Minimalist earn points list ---------- 
.earn-card { 
  margin-top 24px; 
  padding 20px;
  background #fafaf8;
  border-radius var(--radius);
}

.earn-title { 
  font-size 18px; 
  font-weight 600; 
  margin-bottom 20px; 
  color var(--dark);
}

.earn-list {
  display flex;
  flex-direction column;
  gap 0;
}

.earn-item {
  display flex;
  justify-content space-between;
  align-items center;
  padding 16px 0;
  border-bottom 1px solid #eee;
  transition all 0.3s ease;
}

.earn-itemlast-child {
  border-bottom none;
}

.earn-item.claimed {
  opacity 0.5;
  order 999;  Moves to bottom 
}

.earn-item-left {
  display flex;
  align-items center;
  gap 12px;
}

.earn-check {
  width 20px;
  height 20px;
  display flex;
  align-items center;
  justify-content center;
  font-size 18px;
  color #ccc;
  transition all 0.2s ease;
}

.earn-item.claimed .earn-check {
  color var(--success);
}

.earn-label {
  font-size 15px;
  color var(--dark);
}

.earn-item.claimed .earn-label {
  text-decoration line-through;
  color #999;
}

.earn-item-right {
  display flex;
  align-items center;
  gap 12px;
}

.points-badge {
  font-size 13px;
  font-weight 600;
  color var(--secondary);
}

.earn-btn, .earn-link {
  padding 6px 16px;
  font-size 13px;
  font-weight 500;
  background transparent;
  color var(--primary);
  border 1px solid var(--primary);
  border-radius 20px;
  cursor pointer;
  transition all 0.2s ease;
  text-decoration none;
  display inline-block;
}

.earn-btnhover, .earn-linkhover {
  background var(--primary);
  color white;
}

.earn-item.claimed .earn-btn {
  display none;
}

 Remove the old table styles 
.earn-table { display none; }

 Discount code display 
.discount-code-container {
  margin-top 12px;
}

.discount-code-field {
  display flex;
  gap 4px;
  margin-bottom 8px;
}

.discount-code-input {
  flex 1;
  padding 8px 12px;
  border 1px solid #ddd;
  border-radius 4px;
  background #f8f8f8;
  font-family monospace;
  font-size 13px;
  color var(--dark);
  text-align center;
}

.copy-code-btn {
  padding 8px;
  background white;
  border 1px solid #ddd;
  border-radius 4px;
  cursor pointer;
  display flex;
  align-items center;
  justify-content center;
  transition all 0.2s ease;
}

.copy-code-btnhover {
  background #f0f0f0;
}

.copy-code-btn.copied {
  background var(--success);
  border-color var(--success);
}

.copy-code-btn.copied svg {
  stroke white;
}

.cancel-redeem-link {
  background none;
  border none;
  color #999;
  font-size 12px;
  text-decoration underline;
  cursor pointer;
  padding 0;
  margin 0 auto;
  display block;
}

.cancel-redeem-linkhover {
  color var(--primary);
}

.ref-hidden {
  displaynone !important;
}
#referral-url-display.discount-code-input {
  font-family inherit !important;
  font-size 13px !important;
  min-width 350px;
  text-align left !important;
}
@media (min-width 768px) {
  #referral-url-display.discount-code-input {
    min-width 500px;
  }
}
style

div class=account-referrals
  div class=account-header
    div class=header-content
      span class=rewards-titleimg src=httpswww.hemlockandoak.comcdnshopfileslighter-logo-horizontal.png h1 class=account-header-fontRewardsh1span
    div
    p id=referral-url-message style=displaynone;p
  div



  !-- ===================== SECTION 1 POINTS & REWARDS ===================== --
  section class=rewards-shell aria-labelledby=rewards-heading
    div class=points-balance
      div
        div class=points-subYour current pointsdiv
        div class=bigspan id=available-points0spandiv
      div
    
      div class=points-rail
        div class=rail aria-hidden=true
  div id=points-progress-bar class=rail-fill style=width0%;div

  div id=points-progress-marker class=rail-marker style=left0%;
    svg class=pin viewBox=0 0 24 24 aria-hidden=true
      path d=M12 22s7-7.16 7-12a7 7 0 1 0-14 0c0 4.84 7 12 7 12z fill=#ac8e69
      circle cx=12 cy=10 r=3.2 fill=#ffffff
    svg
  div

  !-- Ticks on the bar --
  div class=rail-tick data-points=500span class=tick-dotspanspan class=tick-label500spandiv
  div class=rail-tick data-points=1000span class=tick-dotspanspan class=tick-label1000spandiv
  div class=rail-tick data-points=2000span class=tick-dotspanspan class=tick-label2000spandiv
  div class=rail-tick data-points=3000span class=tick-dotspanspan class=tick-label3000spandiv
div

div
div
section
    

div class=redeem-wrap
  brYou have span id=points-display-redeem0span points available. Choose a reward below!
  
  div class=scrollable-with-controls
    scroll-carousel
      selector=.redeem-options  
      id=scroll-area-redeem
      class=scroll-area bleed {% if 5  3 %}is-scrollable{% endif %}
    
      div class=redeem-options
        {% assign redemptionOptions = 5500,101000,202000,303000  split , %}
        {% for option in redemptionOptions %}
          {% assign parts = option  split  %}
          div class=redeem-option carousel-item
            b{{ parts[0] }} CAD off couponb
            p{{ parts[1] }} Pointsp
            button class=redeem-discount data-points={{ parts[1] }} data-value={{ parts[0] }}CADRedeembutton
            div class=discount-code-container style=displaynone;
              div class=discount-code-field
                input type=text class=discount-code-input readonly
                button class=copy-code-btn title=Copy code
                  svg width=16 height=16 viewBox=0 0 24 24 fill=none stroke=currentColor stroke-width=2
                    rect x=9 y=9 width=13 height=13 rx=2 ry=2rect
                    path d=M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1path
                  svg
                button
              div
              button class=cancel-redeem-linkI don't want this rewardbutton
            div
          div
        {% endfor %}
        div class=redeem-option carousel-item
          bOrder discountb
          p100 Points = 1 CADp
          button class=redeem-discount data-points=100 data-value=dynamicRedeembutton
          div class=discount-code-container style=displaynone;
            div class=discount-code-field
              input type=text class=discount-code-input readonly
              button class=copy-code-btn title=Copy code
                svg width=16 height=16 viewBox=0 0 24 24 fill=none stroke=currentColor stroke-width=2
                  rect x=9 y=9 width=13 height=13 rx=2 ry=2rect
                  path d=M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1path
                svg
              button
            div
            button class=cancel-redeem-linkI don't want this rewardbutton
          div
        div
      div
    scroll-carousel
    
    {%- assign items_visible = 3 -%}
    {%- assign total_items = 5 -%}
    {%- assign default_progress = items_visible  times 1.0  divided_by total_items -%}
    {%- render 'scrollbar', observes 'scroll-area-redeem', default_progress default_progress, show_buttons false -%}
  div
  div class=ref-hidden
  button id=redeem-another style=displaynone;Redeem Anotherbutton
  p id=last-discount-codep
  div id=redeem-messagediv div
div
  

div class=earn-card
  h6 class=ref-h6Earn points. Get more rewards.h6
  brAs a member, you'll collect points on almost everything you buy. Those points add up to some amazing rewards. Look out for some surprises and members-only extras in your inbox!
  div class=earn-list
    !-- Purchase (always at top, can't be claimed) --
    div class=earn-item id=earning-purchase
      div class=earn-item-left
        span class=earn-check○span
        span class=earn-labelMake a purchasespan
      div
      div class=earn-item-right
        span class=points-badge+5  $1span
        a href=collectionsall class=earn-linkShop →a
      div
    div
    
    !-- Social actions --
    div class=earn-item id=earning-instagram
      div class=earn-item-left
        span class=earn-check○span
        span class=earn-labelFollow on Instagramspan
      div
      div class=earn-item-right
        span class=points-badge+50span
        button class=earn-btn data-action=instagramFollowbutton
      div
    div
    
    div class=earn-item id=earning-community
      div class=earn-item-left
        span class=earn-check○span
        span class=earn-labelJoin our communityspan
      div
      div class=earn-item-right
        span class=points-badge+50span
        button class=earn-btn data-action=communityJoinbutton
      div
    div
    
    div class=earn-item id=earning-facebook
      div class=earn-item-left
        span class=earn-check○span
        span class=earn-labelLike on Facebookspan
      div
      div class=earn-item-right
        span class=points-badge+50span
        button class=earn-btn data-action=facebookLikebutton
      div
    div
    
    div class=earn-item id=earning-youtube
      div class=earn-item-left
        span class=earn-check○span
        span class=earn-labelSubscribe on YouTubespan
      div
      div class=earn-item-right
        span class=points-badge+50span
        button class=earn-btn data-action=youtubeSubscribebutton
      div
    div
  div
  
div
!-- Simplified Referral Section --

section class=referrals-shell style=margin-top 24px;
  h6 class=ref-h6Give $15, Get $15h6
  br
    When your friend makes their first purchase using your link, they get $15 off and you get $15 in points!
 
  
  div class=referral-link-box style=margin-bottom 20px;
    div class=discount-code-field
      input type=text id=referral-url-display class=discount-code-input readonly style=font-family inherit; font-size 14px; width 100%;
      button id=copy-referral-btn class=copy-code-btn title=Copy link
        svg width=16 height=16 viewBox=0 0 24 24 fill=none stroke=currentColor stroke-width=2
          rect x=9 y=9 width=13 height=13 rx=2 ry=2rect
          path d=M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1path
        svg
      button
    div
  div
  
  div class=share-buttons
    button class=share-btn id=share-email
      svg xmlns=httpwww.w3.org2000svg width=16 height=16 viewBox=0 0 24 24 fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=roundpath d=M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zpathpolyline points=22,6 12,13 2,6polylinesvg
      Email
    button
    button class=share-btn id=share-facebook
      svg xmlns=httpwww.w3.org2000svg width=16 height=16 viewBox=0 0 24 24 fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=roundpath d=M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3zpathsvg
      Facebook
    button
    button class=share-btn id=share-twitter
      svg xmlns=httpwww.w3.org2000svg width=16 height=16 viewBox=0 0 24 24 fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=roundpath d=M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3zpathsvg
      Twitter
    button
  div
  
  !-- Simple referral counter --
  div style=text-align center; margin-top 24px; padding-top 20px; border-top 1px solid #eee;
    div style=font-size 32px; font-weight 200; color var(--primary);
      span id=referral-count0span
    div
    div style=font-size 14px; color #777; text-transform uppercase; letter-spacing 0.1em;
      Friends Referred
    div
  div
section


div

script
document.addEventListener('DOMContentLoaded', function() {
  const apiBaseUrl   = 'httpsreferral-program-448vr.kinsta.app';
  const apiReviewUrl = 'httpsreviews-kettd.kinsta.app';

  const messageDiv         = document.getElementById('referral-url-message');
  const referralUrlDisplay = document.getElementById('referral-url-display');
  const copyReferralBtn    = document.getElementById('copy-referral-btn');
  const nextRewardMessage  = document.getElementById('next-reward-message');

  const urlParams = new URLSearchParams(window.location.search);
  let emailFromQuery = urlParams.get('email');
  const customerEmail = {{ customer.email  escape }};
  if (!emailFromQuery && customerEmail && customerEmail !== ) emailFromQuery = customerEmail;

  const __isLoggedIn = {% if customer %}true{% else %}false{% endif %};
  const effectiveEmail = emailFromQuery  customerEmail;

  const referralGoal = {{ section.settings.referral_goal  default 50 }};
  let currentUserPoints = 0;
  let referralCount = 0;
  window.referralFirstName = '';

  function showNotification(message, isError=false){
    const n = document.getElementById('referral-notification');
    const m = document.getElementById('notification-message');
    if (!n  !m) return;
    m.textContent = message;
    n.style.display = 'flex';
    n.classList.toggle('error', !!isError);
    setTimeout(()={ n.style.display='none'; }, 5000);
  }
  const closeBtn = document.querySelector('.notification-close');
  if (closeBtn) closeBtn.addEventListener('click', () = {
    const n = document.getElementById('referral-notification'); if (n) n.style.display='none';
  });

   ---------- Copy link ---------- 
 Update the existing copy link handler
if (copyReferralBtn) {
  copyReferralBtn.addEventListener('click', function(){
    const text = referralUrlDisplay.value.trim()  referralUrlDisplay.textContent.trim()  '';
    
    navigator.clipboard.writeText(text).then(() = {
      copyReferralBtn.classList.add('copied');
      setTimeout(() = copyReferralBtn.classList.remove('copied'), 2000);
    }).catch(() = {
       Fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      copyReferralBtn.classList.add('copied');
      setTimeout(() = copyReferralBtn.classList.remove('copied'), 2000);
    });
  });
}

   ---------- Share buttons ---------- 
  const openSite = (url)={ if (url) window.open(url,'_blank','noopener,noreferrer,width=1000,height=800'); };
  document.getElementById('share-email').addEventListener('click', function(){
    const referralUrl = referralUrlDisplay.textContent.trim()  location.href;
    const subject = Check out Hemlock & Oak stationery!;
    const body = `Hey! Use my referral link to sign upnn${referralUrl}`;
    if (navigator.share){ navigator.share({titlesubject,textbody,urlreferralUrl}).catch(()={}); return; }
    const encSub = encodeURIComponent(subject), encBody = encodeURIComponent(body);
    window.location.href = `mailtosubject=${encSub}&body=${encBody}`;
  });
  document.getElementById('share-facebook').addEventListener('click', ()= openSite('httpswww.facebook.comhemlockandoak'));
  document.getElementById('share-twitter').addEventListener('click', ()= openSite('httpsx.comhemlockandoak'));

   ---------- Hide if no email ---------- 
  if (!emailFromQuery){
    messageDiv.innerHTML = 'No referral email provided. Please a href=pagesemail-signup style=colorvar(--primary); text-decorationunderline;sign up herea first.';
    messageDiv.style.display='block'; messageDiv.style.color='var(--error)';
    document.querySelectorAll('.rewards-shell, .referrals-shell').forEach(el= el.style.display='none');
    return;
  }

   ---------- Helpers ---------- 
  function updateReferralProgress(count){
    const bar = document.getElementById('progress-bar');
    const goal = parseInt(bar.dataset.goal  referralGoal, 10)  referralGoal;
    const pct = Math.max(0, Math.min(100, (countgoal)100));
    if (bar){ bar.style.width = pct + '%'; bar.setAttribute('aria-valuenow', count); }
  }

   PATCH also drive the new POINTS rail & marker using the same update used for text
  function updatePointsRail(points){
   Derive max from the largest tick we find; fallback to 3000
  const ticks = Array.from(document.querySelectorAll('.rail-tick'));
  const tickValues = ticks.map(t = parseInt(t.dataset.points, 10)).filter(n = Number.isFinite(n));
  const max = tickValues.length  Math.max(...tickValues)  3000;

   Move fill and marker
  const pct = Math.max(0, Math.min(100, (points  max)  100));
  const fill = document.getElementById('points-progress-bar');
  const marker = document.getElementById('points-progress-marker');
  if (fill) fill.style.width = pct + '%';
  if (marker) marker.style.left = pct + '%';

   Position ticks along the rail and toggle unlocked state
  ticks.forEach(t = {
    const need = parseInt(t.dataset.points, 10)  0;
    const leftPct = Math.max(0, Math.min(100, (need  max)  100));
    t.style.left = leftPct + '%';
    t.classList.toggle('unlocked', points = need);
  });

   Back-compat also light up old dots if they still exist
  document.querySelectorAll('.points-tier .tier-dot').forEach(dot = {
    const need = parseInt(dot.dataset.points, 10)  0;
    dot.classList.toggle('unlocked', points = need);
  });
}

function updateAvailablePointsDisplay(points){
   Format with commas
  const formattedPoints = points.toLocaleString();
  
  document.querySelectorAll('#available-points, #points-display-redeem').forEach(el={ 
    if(el) el.textContent = formattedPoints; 
  });
  updatePointsRail(points);  Pass raw number to rail update
}

   ---------- Milestones init (referral) ---------- 
  async function fetchRedeemedState(email){
    const res = await fetch(`${apiReviewUrl}apireferralredeemed-milestonesemail=${encodeURIComponent(email)}`);
    if (!res.ok) throw new Error('Failed to load redeemed milestones');
    return res.json();
  }
  function renderRedeemedCodes(redeemedMilestones){
    const root = document.getElementById('milestone-codes'); if (!root) return;
    const entries = Object.entries(redeemedMilestones{}).sort((a,b)=Number(a[0])-Number(b[0]));
    root.innerHTML = entries.length  entries.map(([pts,code])=`div style=font-size13px; color#777;${pts} referrals — code${code}codediv`).join('')  '';
  }
  function enableUnlockedMilestones(refCount, redeemedMilestones={}){
    document.querySelectorAll('.milestone-reward').forEach(el={
      const req = parseInt(el.dataset.points,10);
      if (redeemedMilestones[req]){
        el.textContent='Redeemed'; el.style.pointerEvents='none'; el.style.opacity='.5'; el.style.color='gray'; el.style.fontStyle='italic';
        const codeEl = document.createElement('div'); codeEl.textContent=`Code ${redeemedMilestones[req]}`;
        codeEl.style.fontSize='12px'; codeEl.style.marginTop='4px'; codeEl.style.color='#777'; el.parentElement.appendChild(codeEl);
        return;
      }
      if (refCount = req){
        el.style.cursor='pointer';
        if (!el.dataset.clickBound){
          el.dataset.clickBound='1';
          el.addEventListener('click', async ()={
            try{
              const res = await fetch(`${apiReviewUrl}apireferralredeem-milestone`,{
                method'POST', headers{'Content-Type''applicationjson'},
                bodyJSON.stringify({ email emailFromQuery, milestonePoints req })
              });
              const data = await res.json();
              if (!res.ok  data.error){ showNotification(data.error  'Error unlocking reward.', true); return; }
              el.textContent='Redeemed'; el.style.pointerEvents='none'; el.style.opacity='.5'; el.style.color='gray'; el.style.fontStyle='italic';
              const codeEl = document.createElement('div'); codeEl.textContent=`Code ${data.discountCode}`;
              codeEl.style.fontSize='12px'; codeEl.style.marginTop='4px'; codeEl.style.color='#777'; el.parentElement.appendChild(codeEl);
              showNotification(`${data.rewardName} unlocked! Code ${data.discountCode}`);
              const state = await fetchRedeemedState(emailFromQuery);
              renderRedeemedCodes(state.redeemedMilestones);
            }catch(e){ showNotification('Error unlocking reward.', true); }
          }, { oncetrue });
        }
      } else {
        el.style.cursor='not-allowed'; el.style.opacity='.6'; el.title=`Unlock this reward at ${req} referrals`;
      }
    });
  }
  (async function initMilestones(){
    try{
      const state = await fetchRedeemedState(emailFromQuery);
      referralCount = Number(state.referralCount0);
      renderRedeemedCodes(state.redeemedMilestones{});
      enableUnlockedMilestones(referralCount, state.redeemedMilestones{});
    }catch(e){  noop  }
  })();

   ---------- Load user referral info (also drives both progress bars) ---------- 
  async function fetchReferralInfo(emailValue){
    const lastCodeEl = document.getElementById('last-discount-code');
    try{
      const resp = await fetch(`${apiBaseUrl}apireferraluser${encodeURIComponent(emailValue)}`);
      const data = await resp.json();
      if (data.user){
        referralCount     = data.user.referral_count  0;
        currentUserPoints = data.user.points  0;

        updateReferralProgress(referralCount);
        updateAvailablePointsDisplay(currentUserPoints);
         Update the referral count display
const referralCountDisplay = document.getElementById('referral-count');
if (referralCountDisplay) {
  referralCountDisplay.textContent = referralCount;
}

        let redeemedMilestones = {};
        try{ redeemedMilestones = JSON.parse(data.user.referal_discount_code  data.user.milestone_rewards_discount  '{}'); }catch(e){}
        enableUnlockedMilestones(referralCount, redeemedMilestones);
        renderRedeemedCodes(redeemedMilestones);

        const referralCode = data.user.referral_code;
         In fetchReferralInfo, change this line
if (referralUrlDisplay) referralUrlDisplay.textContent = `httpswww.hemlockandoak.compagesemail-signupref=${referralCode}`;

 To this
if (referralUrlDisplay) {
  const url = `httpswww.hemlockandoak.compagesemail-signupref=${referralCode}`;
  if (referralUrlDisplay.tagName === 'INPUT') {
    referralUrlDisplay.value = url;
  } else {
    referralUrlDisplay.textContent = url;
  }
}

        const lastCode = data.user.last_discount_code;
if (lastCode) {
  lastCodeEl.textContent = `Your last redeemed discount code ${lastCode}`;
  document.querySelectorAll('.redeem-discount').forEach(btn = {
    const redeemValue = btn.getAttribute('data-value');
    const points = btn.getAttribute('data-points');
    const expectedPrefix = redeemValue === 'dynamic'
       `POINTS${(parseInt(points,10)100).toFixed(2)}CAD_`
       `POINTS${redeemValue.replace('CAD','')}CAD_`;
    
    if (lastCode.startsWith(expectedPrefix)) {
      const optionDiv = btn.closest('.redeem-option');
      const codeContainer = optionDiv.querySelector('.discount-code-container');
      const codeInput = optionDiv.querySelector('.discount-code-input');
      
      btn.style.display = 'none';
      codeContainer.style.display = 'block';
      codeInput.value = lastCode;
      btn.dataset.redeemed = 'true';
      btn.dataset.discountCode = lastCode;
    }
  });
} else { 
  lastCodeEl.textContent=''; 
}

showNotification('Successfully retrieved your referral information!');

        showNotification('Successfully retrieved your referral information!');
        } else {
   User not found in rewards program - try to auto-enroll them if logged in
  console.log('User not in rewards yet, checking if they have a Shopify account...');
  
  {% if customer %}
     They're logged in but not in rewards - add them now
    try {
      const signupResponse = await fetch(`${apiBaseUrl}apireferralsignup`, {
        method 'POST',
        headers {'Content-Type' 'applicationjson'},
        body JSON.stringify({
          email '{{ customer.email  escape }}',
          firstName '{{ customer.first_name  escape }}',
          shopifyCustomerId '{{ customer.id }}'
        })
      });
      
      if (signupResponse.ok) {
         Wait a moment then reload their info
        showNotification('Welcome to our rewards program! You got 100 bonus points!');
        setTimeout(() = {
          fetchReferralInfo(emailValue);
        }, 500);
      } else {
         Signup failed, show original message
        messageDiv.innerHTML = `You are not registered in our referral program. a href=pagesemail-signup style=colorvar(--primary)Sign up herea.`;
        messageDiv.style.display='block'; 
        messageDiv.style.color='var(--error)';
        document.querySelectorAll('.rewards-shell, .referrals-shell').forEach(el= el.style.display='none');
      }
    } catch (e) {
      console.error('Auto-signup failed', e);
      messageDiv.innerHTML = `Error creating rewards account. Please try again.`;
      messageDiv.style.display='block'; 
      messageDiv.style.color='var(--error)';
    }
  {% else %}
     Not logged in - ask them to log in
    messageDiv.innerHTML = `Please a href=accountloginlog ina to access rewards.`;
    messageDiv.style.display = 'block';
    messageDiv.style.color='var(--error)';
    document.querySelectorAll('.rewards-shell, .referrals-shell').forEach(el= el.style.display='none');
  {% endif %}
}
    }catch(e){
      messageDiv.textContent='Error connecting to referral service.'; messageDiv.style.color='var(--error)'; messageDiv.style.display='block';
      showNotification('Connection error', true);
    }
  }
  fetchReferralInfo(emailFromQuery);

   ---------- Redeem logic (unchanged IDsclasses) ---------- 
  function enableAllOptions(){
    document.querySelectorAll('.redeem-option').forEach(opt={ opt.classList.remove('disabled','selected'); });
    const b = document.getElementById('redeem-another'); if (b) b.style.display='none';
  }
  function disableOtherOptions(selectedBtn){
    const options = document.querySelectorAll('.redeem-option');
    const btn = document.getElementById('redeem-another');
    if (options.length = 1) return;
    options.forEach(opt={
      if (opt !== selectedBtn.closest('.redeem-option')) opt.classList.add('disabled'); else opt.classList.add('selected');
    });
    if (btn) btn.style.display='block';
  }
  document.getElementById('redeem-another').addEventListener('click', enableAllOptions);

  document.querySelectorAll('.redeem-discount').forEach(btn = {
  btn.dataset.redeemed = btn.dataset.redeemed  'false';
  
  btn.addEventListener('click', async (e) = {
    e.preventDefault();
    const requiredPoints = parseInt(btn.getAttribute('data-points'));
    const redeemValue = btn.getAttribute('data-value');
    const redeemMessage = document.getElementById('redeem-message');
    const optionDiv = btn.closest('.redeem-option');
    const codeContainer = optionDiv.querySelector('.discount-code-container');
    const codeInput = optionDiv.querySelector('.discount-code-input');
    
    if (!redeemMessage) return;

    if (btn.dataset.redeemed === 'false') {
      const original = btn.textContent;
      btn.innerHTML = 'span class=loading-indicatorspan Redeeming...';
      btn.disabled = true;

      if (currentUserPoints  requiredPoints) {
        btn.innerHTML = original;
        btn.disabled = false;
        showNotification('Not enough points to redeem this reward.', true);
        return;
      }

      try {
        const response = await fetch(`${apiReviewUrl}apireferralredeem`, {
          method 'POST',
          headers {'Content-Type' 'applicationjson'},
          body JSON.stringify({ 
            email emailFromQuery, 
            pointsToRedeem requiredPoints, 
            redeemType 'discount', 
            redeemValue 
          })
        });
        const data = await response.json();
        btn.disabled = false;

        if (response.ok) {
          redeemMessage.textContent = `Success! Your discount code ${data.discountCode}`;
          redeemMessage.style.color = 'var(--success)';
          currentUserPoints = data.newPoints  0;
          updateAvailablePointsDisplay(currentUserPoints);
          
           Hide the redeem button and show the code field
          btn.style.display = 'none';
          codeContainer.style.display = 'block';
          codeInput.value = data.discountCode;
          btn.dataset.redeemed = 'true';
          btn.dataset.discountCode = data.discountCode;
          
          document.getElementById('last-discount-code').textContent = 
            `Your last redeemed discount code ${data.discountCode}`;
          showNotification('Points successfully redeemed!');
          disableOtherOptions(btn);
        } else {
          btn.innerHTML = original;
          redeemMessage.textContent = data.error  'Error redeeming points.';
          redeemMessage.style.color = 'var(--error)';
          showNotification('Error redeeming points.', true);
        }
      } catch(err) {
        btn.innerHTML = original;
        btn.disabled = false;
        redeemMessage.textContent = 'Connection error.';
        redeemMessage.style.color = 'var(--error)';
        showNotification('Connection error.', true);
      }
    }
  });
});

 Handle copy button clicks
document.querySelectorAll('.copy-code-btn').forEach(btn = {
  btn.addEventListener('click', function() {
    const input = btn.parentElement.querySelector('.discount-code-input');
    const code = input.value;
    
    navigator.clipboard.writeText(code).then(() = {
      btn.classList.add('copied');
      setTimeout(() = btn.classList.remove('copied'), 2000);
    }).catch(() = {
       Fallback for older browsers
      input.select();
      document.execCommand('copy');
      btn.classList.add('copied');
      setTimeout(() = btn.classList.remove('copied'), 2000);
    });
  });
});

 Handle I don't want this reward clicks
document.querySelectorAll('.cancel-redeem-link').forEach(link = {
  link.addEventListener('click', async function() {
    const optionDiv = link.closest('.redeem-option');
    const btn = optionDiv.querySelector('.redeem-discount');
    const codeContainer = optionDiv.querySelector('.discount-code-container');
    const requiredPoints = parseInt(btn.getAttribute('data-points'));
    
    try {
      const response = await fetch(`${apiReviewUrl}apireferralcancel-redeem`, {
        method 'POST',
        headers {'Content-Type' 'applicationjson'},
        body JSON.stringify({ 
          email emailFromQuery, 
          pointsToRefund requiredPoints 
        })
      });
      const data = await response.json();
      
      if (response.ok) {
        const redeemMessage = document.getElementById('redeem-message');
        redeemMessage.textContent = 'Redemption cancelled. Points refunded.';
        redeemMessage.style.color = 'var(--success)';
        currentUserPoints = data.newPoints  0;
        updateAvailablePointsDisplay(currentUserPoints);
        
         Reset the UI
        btn.dataset.redeemed = 'false';
        btn.textContent = 'Redeem';
        btn.style.display = 'block';
        codeContainer.style.display = 'none';
        enableAllOptions();
      }
    } catch(err) {
      showNotification('Error cancelling redemption.', true);
    }
  });
});

   ---------- Earn actions (same containers & buttons) ---------- 
   Around line 437-500, replace with
const ACTION_META = {
  instagram { award 'social_media_follow', containerId 'earning-instagram', label 'Instagram', points 50, url 'httpswww.instagram.comhemlockandoak' },
  community { award 'community_join', containerId 'earning-community', label 'Community', points 50, url 'httpswww.facebook.comgroups930233467699253' },
  facebook { award 'facebook_like', containerId 'earning-facebook', label 'Facebook', points 50, url 'httpswww.facebook.comhemlockandoak' },
  youtube { award 'youtube_subscribe', containerId 'earning-youtube', label 'YouTube', points 50, url 'httpswww.youtube.comchannelUCL_7ysj8qv0w1btNwi1t38A' }
};

function localKey(award){ return `claimed${emailFromQuery}${award}`; }
function lockButton(btn, row) {
  if (!row) return;
  row.classList.add('claimed');
  const check = row.querySelector('.earn-check');
  if (check) check.textContent = '✓';
  if (btn) btn.style.display = 'none';
}
function successLock(btn, row, label){ lockButton(btn,row,{label, color'var(--success)'}); }

 Check localStorage for previously claimed actions
Object.entries(ACTION_META).forEach(([key, meta])={
  const btn = document.querySelector(`.earn-btn[data-action=${key}]`);  Fixed selector
  const row = document.getElementById(meta.containerId);
  if (!btn) return;
  if (localStorage.getItem(localKey(meta.award))==='1') lockButton(btn, row);
});

 Add click handlers to earn buttons
document.querySelectorAll('.earn-btn[data-action]').forEach(btn={  Fixed selector
  btn.addEventListener('click', async ()={
    const key = btn.getAttribute('data-action'); 
    const meta = ACTION_META[key]; 
    if (!meta) return;
    
    const row = document.getElementById(meta.containerId);
    if (btn.dataset.claimed==='true'  row.classList.contains('claimed')) return;
    if (meta.url) window.open(meta.url,'_blank');

    const original = btn.textContent;
    btn.innerHTML = 'span class=loading-indicatorspan Processing...'; 
    btn.disabled=true;

    try{
      const response = await fetch(`${apiBaseUrl}apireferralaward`,{
        method'POST', 
        headers{'Content-Type''applicationjson'},
        bodyJSON.stringify({ email emailFromQuery, action meta.award })
      });
      const data = await response.json();
      btn.disabled=false;

      if (response.ok){
        currentUserPoints = (data.newPoints!=null)  data.newPoints  (currentUserPoints + (meta.points  0));
        updateAvailablePointsDisplay(currentUserPoints);
        showNotification(`+${meta.points} points for ${meta.label}!`);
        const msg = document.getElementById('award-message');
        if (msg){ 
          msg.textContent = `Thanks! You've been awarded ${meta.points} points. New total ${currentUserPoints}.`; 
          msg.style.color='var(--success)'; 
          msg.style.display='block'; 
        }
        localStorage.setItem(localKey(meta.award),'1'); 
        successLock(btn,row,`${meta.label} ✓`);
      } else {
        const msgText = data.error  data.message  'Error awarding points.'; 
        showNotification(msgText, true);
        const msg = document.getElementById('award-message');
        if (msg){ 
          msg.textContent = msgText; 
          msg.style.color='var(--error)'; 
          msg.style.display='block'; 
        }
        if ((msgText'').toLowerCase().includes('points already claimed')){
          localStorage.setItem(localKey(meta.award),'1'); 
          lockButton(btn,row);
        } else { 
          btn.innerHTML = original; 
          btn.disabled=false; 
        }
      }
    }catch(e){
      btn.innerHTML = original; 
      btn.disabled=false;
      showNotification('Connection error.', true);
      const msg = document.getElementById('award-message');
      if (msg){ 
        msg.textContent = 'Error connecting to referral service.'; 
        msg.style.color='var(--error)'; 
        msg.style.display='block'; 
      }
    }
  });
});

   ---------- Auto-login helper (unchanged) ---------- 
  function autoLoginShopify(email, password, returnTo){
    const f = document.createElement('form'); f.method='POST'; f.action='accountlogin'; f.style.display='none';
    const e = Object.assign(document.createElement('input'), {type'hidden', name'customer[email]', valueemail});
    const p = Object.assign(document.createElement('input'), {type'hidden', name'customer[password]', valuepassword});
    const r = Object.assign(document.createElement('input'), {type'hidden', name'return_to', valuereturnTowindow.location.href});
    f.appendChild(e); f.appendChild(p); f.appendChild(r); document.body.appendChild(f); f.submit();
  }
  (function attemptAutoLoginOnce(){
    if (__isLoggedIn  !effectiveEmail) return;
    const payloadKey = `autologin_payload${effectiveEmail}`, attemptKey = `autologin_attempt${effectiveEmail}`;
    try{
      const payload = JSON.parse(sessionStorage.getItem(payloadKey)  'null');
      const lastAttempt = Number(sessionStorage.getItem(attemptKey)  0);
      const fresh = payload && (Date.now() - payload.ts  120000);
      const cooled = !lastAttempt  (Date.now() - lastAttempt  15000);
      if (fresh && cooled){ sessionStorage.setItem(attemptKey, String(Date.now())); autoLoginShopify(effectiveEmail, payload.pw, window.location.href); }
      sessionStorage.removeItem(payloadKey);
    }catch(e){}
  })();

   ---------- Preserve email in links ---------- 
  if (emailFromQuery){
    const emailSignupLink = document.querySelector('a[href=pagesemail-signup]');
    const referralPageLink = document.querySelector('a[href=pagesreferral-page]');
    if (emailSignupLink) emailSignupLink.href = `pagesemail-signupemail=${encodeURIComponent(emailFromQuery)}`;
    if (referralPageLink) referralPageLink.href = `pagesreferral-pageemail=${encodeURIComponent(emailFromQuery)}`;
  }
  
});
script

{% schema %}
{
  name Rewards,
  settings [
    { type number, id referral_goal, label Referral Goal, default 15 }
  ],
  blocks [
    {
      type milestone,
      name Milestone,
      settings [
        { type number, id milestone_count, label Referral Count for Reward, default 5 },
        { type text, id reward_name, label Reward Name (e.g. Free Planner), default Free Notebook },
        { type range, id position, label Progress Bar Position (%), min 0, max 100, step 1, default 33 }
      ]
    }
  ],
  max_blocks 5,
  presets [{ name Rewards & Referrals (Starbucks), category Custom }]
}
{% endschema %}
